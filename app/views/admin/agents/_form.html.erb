<%= form_with model: [:admin, @agent], local: true do |f| %>
  <% if @agent.errors.any? %>
    <div style="background: #f2dede; border: 1px solid #ebccd1; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
      <strong>Please fix the following errors:</strong>
      <ul>
        <% @agent.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <fieldset style="margin-bottom: 1.5rem;">
    <legend>Basic Settings</legend>

    <% if @agent.new_record? %>
      <div style="margin-bottom: 1rem;">
        <%= label_tag :username, "Username", style: "display: block; font-weight: bold;" %>
        <%= text_field_tag :username, params[:username], placeholder: "agent_daily", style: "width: 100%; max-width: 300px;" %>
        <div style="color: #666; font-size: 0.85em;">Will be prefixed with "agent_" if not already.</div>
      </div>
    <% end %>

    <div style="margin-bottom: 1rem;">
      <%= f.label :name, style: "display: block; font-weight: bold;" %>
      <%= f.text_field :name, placeholder: "Daily AI Digest", style: "width: 100%; max-width: 400px;" %>
    </div>

    <div style="margin-bottom: 1rem;">
      <%= f.label :description, style: "display: block; font-weight: bold;" %>
      <%= f.text_area :description, rows: 3, placeholder: "Curates top AI in finance stories daily...", style: "width: 100%;" %>
    </div>

    <div style="margin-bottom: 1rem;">
      <%= f.label :enabled, style: "font-weight: bold;" %>
      <%= f.check_box :enabled %> Active
    </div>
  </fieldset>

  <fieldset style="margin-bottom: 1.5rem;">
    <legend>Scheduling</legend>

    <div style="margin-bottom: 1rem;">
      <%= f.label :schedule_interval, "Schedule", style: "display: block; font-weight: bold;" %>
      <%= f.select :schedule_interval, [
        ["Every 15 minutes", "15_minutes"],
        ["Every hour", "hourly"],
        ["Every 2 hours", "2_hours"],
        ["Every 6 hours", "6_hours"],
        ["Every 12 hours", "12_hours"],
        ["Once daily", "daily"]
      ] %>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
      <div>
        <%= f.label :posts_per_run, "Posts Per Run", style: "display: block; font-weight: bold;" %>
        <%= f.number_field :posts_per_run, min: 1, max: 50, style: "width: 100px;" %>
      </div>
      <div>
        <%= f.label :max_daily_posts, "Max Daily Posts", style: "display: block; font-weight: bold;" %>
        <%= f.number_field :max_daily_posts, min: 1, max: 200, style: "width: 100px;" %>
      </div>
    </div>
  </fieldset>

  <fieldset style="margin-bottom: 1.5rem;">
    <legend>Trust Level</legend>

    <div style="margin-bottom: 1rem;">
      <%= f.label :trust_level, style: "display: block; font-weight: bold;" %>
      <label style="display: block; margin-bottom: 0.5rem;">
        <%= f.radio_button :trust_level, "review" %>
        <strong>Review</strong> - Posts require human approval before going live
      </label>
      <label style="display: block;">
        <%= f.radio_button :trust_level, "trusted" %>
        <strong>Trusted</strong> - Posts go live immediately (auto-approved)
      </label>
    </div>
  </fieldset>

  <fieldset style="margin-bottom: 1.5rem;">
    <legend>Content Sources</legend>

    <div style="margin-bottom: 1rem;">
      <label style="display: block; font-weight: bold;">RSS Feeds</label>
      <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px;">
        <% @rss_feeds.each do |feed| %>
          <label style="display: block; margin-bottom: 0.25rem;">
            <%= check_box_tag "rss_feed_ids[]", feed.id, @agent.rss_feeds.include?(feed) %>
            <%= feed.name %> (<%= feed.category || 'No category' %>)
          </label>
        <% end %>
        <% if @rss_feeds.empty? %>
          <p style="color: #666;">No RSS feeds available. <%= link_to "Add feeds first", admin_rss_feeds_path %>.</p>
        <% end %>
      </div>
    </div>

    <div style="margin-bottom: 1rem;">
      <label style="font-weight: bold;">
        <%= check_box_tag :web_search_enabled, "1", @agent.web_search_enabled? %>
        Enable Web Search
      </label>
      <div style="color: #666; font-size: 0.85em;">Uses AI to search the web for relevant content (costs API tokens).</div>
    </div>

    <div style="margin-bottom: 1rem;">
      <label style="display: block; font-weight: bold;">Web Search Queries (one per line)</label>
      <%= text_area_tag :web_search_queries, @agent.web_search_queries.join("\n"), rows: 4, placeholder: "AI in credit unions\nmachine learning fintech\n...", style: "width: 100%;" %>
    </div>
  </fieldset>

  <fieldset style="margin-bottom: 1.5rem;">
    <legend>Keyword Filtering</legend>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
      <div>
        <label style="display: block; font-weight: bold;">Required Keywords (comma-separated)</label>
        <%= text_field_tag :required_keywords, @agent.required_keywords.join(", "), placeholder: "ai, credit union, fintech", style: "width: 100%;" %>
        <div style="color: #666; font-size: 0.85em;">Content must contain at least one of these.</div>
      </div>
      <div>
        <label style="display: block; font-weight: bold;">Excluded Keywords (comma-separated)</label>
        <%= text_field_tag :excluded_keywords, @agent.excluded_keywords.join(", "), placeholder: "crypto, nft, blockchain", style: "width: 100%;" %>
        <div style="color: #666; font-size: 0.85em;">Content with these will be penalized.</div>
      </div>
    </div>
  </fieldset>

  <fieldset style="margin-bottom: 1.5rem;">
    <legend>Quality Settings</legend>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
      <div>
        <label style="display: block; font-weight: bold;">Relevance Threshold</label>
        <%= number_field_tag :relevance_threshold, @agent.relevance_threshold, min: 0, max: 1, step: 0.1, style: "width: 100px;" %>
        <div style="color: #666; font-size: 0.85em;">0.0 to 1.0 (e.g., 0.5 = 50%)</div>
      </div>
      <div>
        <label style="display: block; font-weight: bold;">Max Content Age (hours)</label>
        <%= number_field_tag :max_age_hours, @agent.max_age_hours, min: 1, max: 168, style: "width: 100px;" %>
      </div>
    </div>

    <div style="margin-bottom: 1rem;">
      <label style="font-weight: bold;">
        <%= check_box_tag :llm_vetting_enabled, "1", @agent.llm_vetting_enabled? %>
        Enable LLM Quality Analysis
      </label>
      <div style="color: #666; font-size: 0.85em;">Uses AI to analyze content quality (costs API tokens).</div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
      <div>
        <label style="display: block; font-weight: bold;">LLM Minimum Score</label>
        <%= number_field_tag :llm_min_score, @agent.llm_min_score, min: 0, max: 1, step: 0.1, style: "width: 100px;" %>
      </div>
      <div>
        <label style="display: block; font-weight: bold;">Max Candidates for LLM</label>
        <%= number_field_tag :max_candidates_for_llm, @agent.max_candidates_for_llm, min: 1, max: 50, style: "width: 100px;" %>
      </div>
    </div>

    <div style="margin-top: 1rem;">
      <label style="display: block; font-weight: bold;">Trusted Domains (one per line)</label>
      <%= text_area_tag :trusted_domains, @agent.trusted_domains.join("\n"), rows: 3, placeholder: "ieee.org\nacm.org\n...", style: "width: 100%;" %>
      <div style="color: #666; font-size: 0.85em;">These domains get higher quality scores.</div>
    </div>
  </fieldset>

  <div style="margin-top: 2rem;">
    <%= f.submit @agent.new_record? ? "Create Agent" : "Update Agent", class: "btn" %>
    <% unless @agent.new_record? %>
      <%= link_to "Delete", admin_agent_path(@agent), method: :delete,
          data: {confirm: "Are you sure you want to delete this agent?"}, class: "btn", style: "background: #d9534f;" %>
    <% end %>
  </div>
<% end %>
